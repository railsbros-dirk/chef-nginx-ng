#
# Generated by Chef for <%= node[:fqdn] %> at <%= Time.now %>
# <%= node[:roles].inspect %>

server {
  listen 80;

  <% @application["server_names"].each do |name|%>
  server_name <%= name %>;
  <% end %>

  root <%= "#{@application["root_dir"] || node[:passenger][:www_dir]}/#{@application["id"]}/current/public" %>;

  passenger_enabled on;
  passenger_spawn_method <%= node[:passenger][:spawn_method] %>;
  passenger_min_instances <%= node[:passenger][:min_instances] %>;

  client_max_body_size <%= node[:nginx_ng][:client_max_body_size] %>;

  <% if @certificate && @application["ssl_only"] %>
  if ($ssl_protocol = "") {
    rewrite ^   https://$server_name$request_uri? permanent;
  }
  <% end %>

}

<% if @certificate %>
server {
  listen 443;

  <% @application["server_names"].each do |name|%>
  server_name <%= name %>;
  <% end %>

  root <%= "#{@application["root_dir"] || node[:passenger][:www_dir]}/#{@application["id"]}/current/public" %>;

  passenger_enabled on;
  passenger_spawn_method <%= node[:passenger][:spawn_method] %>;
  passenger_min_instances <%= node[:passenger][:min_instances] %>;

  client_max_body_size <%= node[:nginx_ng][:client_max_body_size] %>;

  ssl on;
  ssl_certificate      /<%= node[:nginx_ng][:dir] %>/ssl/<%= @certificate["id"] %>.crt;
  ssl_certificate_key  /<%= node[:nginx_ng][:dir] %>/ssl/<%= @certificate["id"] %>.key;

  if ($ssl_protocol = "") {
    rewrite ^   https://$server_name$request_uri? permanent;
  }
}
<% end %>